<div class="w-full lg:mx-auto lg:w-1/3 lg:mt-10">
  <h2>History</h2>
  <mat-card class="mb-3">
    <div class="w-auto">
      <div class="text-gray-400">Your Balance</div>
      <div class="flex w-full flex-wrap text-center">
        <ng-container *ngIf="insufficiencyAmount">
          <div class="w-full">
            <div class="break-words text-red-400">
              Insufficient Balance:
              <span class="text-2xl">{{ insufficiencyAmount | microNumber }}</span>
            </div>
          </div>
        </ng-container>
        <div class="w-2/5 m-auto break-words">
          UPX: <span class="text-2xl">{{ uupxAmount | microNumber }}</span>
        </div>
        <div class="w-2/5 m-auto break-words">
          SPX:<span class="text-2xl">{{ uspxAmount | microNumber }}</span>
        </div>
      </div>
    </div>
  </mat-card>

  <mat-card class="mb-3">
    <div class="text-gray-400 mb-2">Your Transaction history</div>
    <details>
      <summary>Search Options</summary>
      <mat-card-content class="mt-2">
        <mat-form-field appearance="fill" class="w-24 mr-3">
          <mat-label>Token Type</mat-label>
          <mat-select class="w-5 text-xs" [(value)]="selectedTokenType" (valueChange)="onSelectedTokenTypeChanged($event)">
            <mat-option *ngFor="let tokenType of tokenTypeOptions" [value]="tokenType.value">{{ tokenType.viewValue }} </mat-option>
          </mat-select>
        </mat-form-field>

        <mat-form-field appearance="fill" class="w-44 mr-3">
          <mat-label>Transaction Type </mat-label>
          <mat-select class="w-5 text-xs" [(value)]="selectedTxType" (valueChange)="onSelectedTxTypeChanged($event)">
            <mat-option *ngFor="let txType of txTypeOptions" [value]="txType.value">{{ txType.viewValue }} </mat-option>
          </mat-select>
        </mat-form-field>

        <mat-form-field appearance="fill" class="w-auto">
          <mat-label>Select a date range</mat-label>
          <mat-date-range-input [formGroup]="range" [rangePicker]="picker">
            <input matStartDate formControlName="start" placeholder="Start date" />
            <input matEndDate formControlName="end" placeholder="End date" (dateChange)="onSelectedDateRangeChanged()" />
          </mat-date-range-input>
          <mat-hint>MM/DD/YYYY – MM/DD/YYYY</mat-hint>
          <mat-datepicker-toggle matSuffix [for]="picker"></mat-datepicker-toggle>
          <mat-date-range-picker #picker></mat-date-range-picker>
        </mat-form-field>
      </mat-card-content>
    </details>

    <mat-nav-list>
      <ng-container *ngIf="balanceHistories === null; then loading; else loadedHistory"></ng-container>
      <ng-template #loading>
        <mat-progress-spinner [diameter]="60" [mode]="'indeterminate'"></mat-progress-spinner>
      </ng-template>
      <ng-template #loadedHistory>
        <ng-container *ngIf="!balanceHistories?.length">
          <mat-list-item>No history</mat-list-item>
        </ng-container>
        <mat-divider [inset]="true"></mat-divider>
        <ng-container *ngFor="let balanceHistory of balanceHistories">
          <mat-list-item
            routerLink="/txs/history/{{ powerType(balanceHistory.isSolar) }}/{{ txType(balanceHistory.isBid) }}/{{ balanceHistory.id }}"
          >
            <div class="table-column">
              <div class="text-xs mr-4">{{ balanceHistory.date | date: 'YY/MM/dd' }}</div>
              <div class="text-xs mr-4">{{ balanceHistory.date | date: 'HH:mm' }}</div>
            </div>
            <ng-container *ngIf="balanceHistory.isPrimary === true; then primary; else others"></ng-container>
            <ng-template #primary>
              <div class="text-sm mr-10">UPX</div>

              <div class="text-sm flex-auto">
                <span style="color: #3f51b5">+{{ balanceHistory.utokenAmount | microString }}</span>
              </div>
              <div class="text-sm">Primary</div>
            </ng-template>
            <ng-template #others>
              <ng-container *ngIf="balanceHistory.isAccepted === true; then accept; else reject"></ng-container>
              <ng-template #accept>
                <ng-container *ngIf="balanceHistory.isSolar === true; then solar; else utility"></ng-container>
                <ng-template #solar>
                  <div class="table-column">
                    <div class="text-sm mr-10">SPX</div>
                    <div class="text-xs text-gray-400">￥{{ balanceHistory.ujpyContractPrice | microString }}</div>
                  </div>
                  <div class="text-sm flex-auto">
                    <ng-container *ngIf="balanceHistory.isBid === true; then solarBid; else solarAsk"></ng-container>
                    <ng-template #solarBid>
                      <span style="color: #3f51b5">+{{ balanceHistory.utokenAmount | microString }}</span>
                    </ng-template>
                    <ng-template #solarAsk>
                      <span style="color: #ff4081">- {{ balanceHistory.utokenAmount | microString }}</span>
                    </ng-template>
                  </div>
                  <div class="text-sm">Auction</div>
                </ng-template>
                <ng-template #utility>
                  <div class="table-column">
                    <div class="text-sm mr-10">UPX</div>
                    <div class="text-xs text-gray-400">￥{{ balanceHistory.ujpyContractPrice | microString }}</div>
                  </div>
                  <div class="text-sm flex-auto">
                    <ng-container *ngIf="balanceHistory.isBid === true; then utilityBid; else utilityAsk"></ng-container>
                    <ng-template #utilityBid>
                      <span style="color: #3f51b5">+{{ balanceHistory.utokenAmount | microString }}</span>
                    </ng-template>
                    <ng-template #utilityAsk>
                      <span style="color: #ff4081">- {{ balanceHistory.utokenAmount | microString }}</span>
                    </ng-template>
                  </div>
                  <div class="text-sm">Auction</div>
                </ng-template>
              </ng-template>
              <ng-template #reject>
                <ng-container *ngIf="balanceHistory.isSolar === true; then solar; else utility"></ng-container>
                <ng-template #solar>
                  <div class="table-column">
                    <div class="text-sm mr-10">SPX</div>
                    <div class="text-xs text-red-400">Rejected</div>
                  </div>
                  <div class="text-sm flex-auto">
                    <ng-container *ngIf="balanceHistory.isBid === true; then solarBid; else solarAsk"></ng-container>
                    <ng-template #solarBid>
                      <span class="text-gray-400">(+{{ balanceHistory.utokenAmount | microString }})</span>
                    </ng-template>
                    <ng-template #solarAsk>
                      <span class="text-gray-400">(- {{ balanceHistory.utokenAmount | microString }})</span>
                    </ng-template>
                  </div>
                  <div class="text-sm">Auction</div>
                </ng-template>
                <ng-template #utility>
                  <div class="table-column">
                    <div class="text-sm mr-10">UPX</div>
                    <div class="text-xs text-red-400">Rejected</div>
                  </div>
                  <div class="text-sm flex-auto">
                    <ng-container *ngIf="balanceHistory.isBid === true; then utilityBid; else utilityAsk"></ng-container>
                    <ng-template #utilityBid>
                      <span class="text-gray-400">(+{{ balanceHistory.utokenAmount | microString }})</span>
                    </ng-template>
                    <ng-template #utilityAsk>
                      <span class="text-gray-400">(- {{ balanceHistory.utokenAmount | microString }})</span>
                    </ng-template>
                  </div>
                  <div class="text-sm">Auction</div>
                </ng-template>
              </ng-template>
            </ng-template>
          </mat-list-item>
          <mat-divider [inset]="true"></mat-divider>
        </ng-container>
      </ng-template>
    </mat-nav-list>
  </mat-card>

  <mat-card class="mb-3">
    <mat-nav-list>
      <div class="text-gray-400 mb-2">Your Daily Withdraw history</div>
      <ng-container *ngIf="paymentHistories === null; then loading; else loadedPaymentHistory"></ng-container>
      <ng-template #loading>
        <mat-progress-spinner [diameter]="60" [mode]="'indeterminate'"></mat-progress-spinner>
      </ng-template>
      <ng-template #loadedPaymentHistory>
        <ng-container *ngIf="!paymentHistories?.length">
          <mat-list-item>No history</mat-list-item>
        </ng-container>
        <mat-divider [inset]="true"></mat-divider>
        <ng-container *ngFor="let paymentHistory of paymentHistories">
          <mat-list-item routerLink="/txs/history/dailyWithdraw{{ powerType(paymentHistory.isSolar) }}/{{ paymentHistory.id }}">
            <div class="table-column">
              <div class="text-xs mr-4">{{ paymentHistory.date | date: 'YY/MM/dd' }}</div>
              <div class="text-xs mr-4">{{ paymentHistory.date | date: 'HH:mm' }}</div>
            </div>
            <ng-container *ngIf="paymentHistory.isSolar === true; then solar; else others"></ng-container>
            <ng-template #solar>
              <div class="w-1/3 text-sm mr-10">SPX</div>
              <div class="text-sm flex-auto text-center">
                <span>{{ paymentHistory.utokenAmount | microString }}</span>
              </div>
            </ng-template>
            <ng-template #others>
              <ng-container *ngIf="paymentHistory.isInsufficiency === true; then insufficiency; else utility"></ng-container>
              <ng-template #insufficiency>
                <div class="w-1/3 text-sm mr-10">Insufficiency</div>
                <div class="text-sm flex-auto text-center">
                  <span>{{ paymentHistory.utokenAmount | microString }}</span>
                </div>
              </ng-template>
              <ng-template #utility>
                <div class="w-1/3 text-sm mr-10">UPX</div>
                <div class="text-sm flex-auto text-center">
                  <span>{{ paymentHistory.utokenAmount | microString }}</span>
                </div>
              </ng-template>
            </ng-template>

            <mat-divider [inset]="true"></mat-divider>
          </mat-list-item>
        </ng-container>
      </ng-template>
    </mat-nav-list>
  </mat-card>
</div>
